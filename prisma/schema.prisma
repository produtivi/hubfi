// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relacionamentos
  presells      Presell[]
  pixels        Pixel[]
  googleAccounts GoogleAccount[]
  googleAdsAccounts GoogleAdsAccount[]
  
  @@map("users")
}

model Domain {
  id         Int      @id @default(autoincrement())
  domainName String   @unique @map("domain_name")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  
  // Relacionamentos
  presells   Presell[]
  
  @@map("domains")
}

model Presell {
  id                 Int      @id @default(autoincrement())
  userId             Int      @map("user_id")
  domainId           Int      @map("domain_id")
  pageName           String   @map("page_name")
  slug               String
  affiliateLink      String   @map("affiliate_link")
  producerSalesPage  String   @map("producer_sales_page")
  presellType        String   @map("presell_type")
  language           String
  status             String   @default("draft")
  
  // Conteúdo gerado
  headline           String?
  subheadline        String?
  contentHtml        String?  @map("content_html")
  metaTitle          String?  @map("meta_title")
  metaDescription    String?  @map("meta_description")
  
  // Screenshots
  screenshotDesktop  String?  @map("screenshot_desktop")
  screenshotMobile   String?  @map("screenshot_mobile")
  
  // Métricas
  views              Int      @default(0)
  clicks             Int      @default(0)
  
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  publishedAt        DateTime? @map("published_at")
  
  // Relacionamentos
  user               User     @relation(fields: [userId], references: [id])
  domain             Domain   @relation(fields: [domainId], references: [id])
  analytics          PresellAnalytics[]
  
  @@unique([domainId, slug])
  @@map("presells")
}

model PresellTemplate {
  id           Int      @id @default(autoincrement())
  name         String
  type         String
  templateHtml String   @map("template_html")
  thumbnailUrl String?  @map("thumbnail_url")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  
  @@map("presell_templates")
}

model PresellAnalytics {
  id        Int      @id @default(autoincrement())
  presellId Int      @map("presell_id")
  eventType String   @map("event_type")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  referer   String?
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relacionamentos
  presell   Presell  @relation(fields: [presellId], references: [id])
  
  @@map("presell_analytics")
}

model Pixel {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  name        String
  platform    String   // hotmart, braip, monetizze, etc.
  presellUrl  String?  @map("presell_url")
  pixelId     String   @unique @map("pixel_id") // ID único para o código de tracking
  status      String   @default("active") // active, inactive
  
  // Métricas básicas
  visits              Int      @default(0)                    // Total de visitas
  uniqueVisits        Int      @default(0) @map("unique_visits")        // Visitas únicas
  cleanVisits         Int      @default(0) @map("clean_visits")         // Visitas limpas (sem bots)
  paidTrafficVisits   Int      @default(0) @map("paid_traffic_visits")  // Visitas de tráfego pago
  clicks              Int      @default(0)                    // Cliques na página
  checkouts           Int      @default(0)                    // Checkouts
  sales               Int      @default(0)                    // Vendas
  bounceRate          Decimal  @default(0) @map("bounce_rate") @db.Decimal(5,2) // Taxa de fuga (0.00 - 100.00)
  blockedIps          Int      @default(0) @map("blocked_ips")          // IPs bloqueados
  
  // Métricas antigas (manter compatibilidade)
  conversions         Int      @default(0)                    // Deprecated - usar sales
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relacionamentos
  user        User     @relation(fields: [userId], references: [id])
  events      PixelEvent[]
  blockedIpsList BlockedIp[] // Lista de IPs bloqueados
  
  @@map("pixels")
}

model PixelEvent {
  id        Int      @id @default(autoincrement())
  pixelId   Int      @map("pixel_id")
  eventType String   @map("event_type") // visit, click, conversion, checkout, sale
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  referer   String?
  url       String?  // URL onde o evento ocorreu
  timestamp DateTime @default(now())
  data      Json?    // dados extras do evento (valor da venda, produto, etc)
  
  // Flags para análise
  isBot     Boolean  @default(false) @map("is_bot")        // Se foi identificado como bot
  isPaid    Boolean  @default(false) @map("is_paid")       // Se veio de tráfego pago
  isUnique  Boolean  @default(false) @map("is_unique")     // Se é visita única
  
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relacionamentos
  pixel     Pixel    @relation(fields: [pixelId], references: [id])
  
  @@map("pixel_events")
}

model BlockedIp {
  id        Int      @id @default(autoincrement())
  pixelId   Int      @map("pixel_id")
  ipAddress String   @map("ip_address")
  reason    String   // Motivo do bloqueio: "bot", "suspicious", "manual", etc
  userAgent String?  @map("user_agent")
  attempts  Int      @default(1) // Número de tentativas bloqueadas
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relacionamentos
  pixel     Pixel    @relation(fields: [pixelId], references: [id])
  
  @@unique([pixelId, ipAddress])
  @@map("blocked_ips")
}

model GoogleAccount {
  id           Int       @id @default(autoincrement())
  userId       Int       @map("user_id")
  email        String
  accessToken  String    @map("access_token") @db.Text
  refreshToken String    @map("refresh_token") @db.Text
  expiresAt    DateTime? @map("expires_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  
  // Relacionamentos
  user         User      @relation(fields: [userId], references: [id])
  
  @@unique([userId, email])
  @@map("google_accounts")
}

model GoogleAdsAccount {
  id            Int       @id @default(autoincrement())
  userId        Int       @map("user_id")
  customerId    String    @map("customer_id") @unique
  accountName   String    @map("account_name")
  mccAccountId  String?   @map("mcc_account_id")
  currencyCode  String    @default("BRL") @map("currency_code")
  timeZone      String    @default("America/Sao_Paulo") @map("time_zone")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@map("google_ads_accounts")
}

// HubTitle - Gerador de Títulos e Descrições
model TitleProduct {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  name        String   // Nome do produto
  description String   @db.Text // Descrição completa
  links       String?  // Links do produto
  category    String?  // Categoria
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  titles      GeneratedTitle[]
  descriptions GeneratedDescription[]

  @@map("title_products")
}

model GeneratedTitle {
  id          Int      @id @default(autoincrement())
  productId   Int      @map("product_id")
  content     String   @db.Text
  isFavorite  Boolean  @default(false) @map("is_favorite")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relacionamentos
  product     TitleProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("generated_titles")
  @@index([productId, isFavorite])
}

model GeneratedDescription {
  id          Int      @id @default(autoincrement())
  productId   Int      @map("product_id")
  content     String   @db.Text
  isFavorite  Boolean  @default(false) @map("is_favorite")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relacionamentos
  product     TitleProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("generated_descriptions")
  @@index([productId, isFavorite])
}