(function() {
  'use strict';

  // Configuração
  var PIXEL_ID = null;
  var API_BASE = null;
  var DEBUG = false;

  // Detectar o pixelId do script
  function getPixelId() {
    var scripts = document.getElementsByTagName('script');
    for (var i = 0; i < scripts.length; i++) {
      var src = scripts[i].src;
      if (src && src.indexOf('hubpixel') !== -1) {
        // Tentar pegar do data-attribute primeiro
        var dataPixelId = scripts[i].getAttribute('data-pixel-id');
        if (dataPixelId) return dataPixelId;

        // Ou do query string
        var match = src.match(/[?&]pixelId=([^&]+)/);
        if (match) return match[1];
      }
    }
    return null;
  }

  // Detectar URL base da API
  function getApiBase() {
    var scripts = document.getElementsByTagName('script');
    for (var i = 0; i < scripts.length; i++) {
      var src = scripts[i].src;
      if (src && src.indexOf('hubpixel') !== -1) {
        var url = new URL(src);
        return url.origin;
      }
    }
    return '';
  }

  // Enviar evento para API
  function sendEvent(eventType, data) {
    if (!PIXEL_ID) {
      if (DEBUG) console.warn('[HubPixel] Pixel ID não encontrado');
      return;
    }

    var payload = {
      eventType: eventType,
      url: window.location.href,
      referrer: document.referrer || null,
      userAgent: navigator.userAgent,
      data: data || {}
    };

    // Adicionar dados de UTM se existirem
    var urlParams = new URLSearchParams(window.location.search);
    var utmParams = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'gclid', 'fbclid'];
    utmParams.forEach(function(param) {
      var value = urlParams.get(param);
      if (value) {
        payload.data[param] = value;
      }
    });

    var endpoint = API_BASE + '/api/pixels/' + PIXEL_ID + '/track';

    // Usar sendBeacon se disponível (mais confiável para eventos de saída)
    if (navigator.sendBeacon && eventType !== 'visit') {
      var blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
      navigator.sendBeacon(endpoint, blob);
      if (DEBUG) console.log('[HubPixel] Evento enviado via beacon:', eventType, payload);
    } else {
      // Fallback para fetch
      fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload),
        keepalive: true
      }).then(function(response) {
        if (DEBUG) {
          response.json().then(function(data) {
            console.log('[HubPixel] Resposta:', data);
          });
        }
      }).catch(function(error) {
        if (DEBUG) console.error('[HubPixel] Erro:', error);
      });
    }
  }

  // Rastrear cliques em links externos e botões de checkout
  function trackClicks() {
    document.addEventListener('click', function(e) {
      var target = e.target.closest('a, button, [data-hubpixel-track]');
      if (!target) return;

      var isCheckoutLink = false;
      var linkUrl = null;

      // Verificar se é um link
      if (target.tagName === 'A') {
        linkUrl = target.href;

        // Detectar links de checkout conhecidos
        var checkoutPatterns = [
          /pay\.hotmart/i,
          /checkout/i,
          /kiwify/i,
          /eduzz/i,
          /monetizze/i,
          /braip/i,
          /lastlink/i,
          /ticto/i,
          /pepper/i
        ];

        isCheckoutLink = checkoutPatterns.some(function(pattern) {
          return pattern.test(linkUrl);
        });
      }

      // Verificar data-attributes
      if (target.hasAttribute('data-hubpixel-track')) {
        var trackType = target.getAttribute('data-hubpixel-track');
        if (trackType === 'checkout') {
          isCheckoutLink = true;
        }
      }

      // Enviar evento apropriado
      if (isCheckoutLink) {
        sendEvent('checkout', {
          targetUrl: linkUrl,
          buttonText: target.textContent ? target.textContent.trim().substring(0, 100) : null
        });
      } else if (target.tagName === 'A' && linkUrl && linkUrl.indexOf(window.location.hostname) === -1) {
        // Clique em link externo
        sendEvent('click', {
          targetUrl: linkUrl,
          isExternal: true
        });
      }
    }, true);
  }

  // Rastrear tempo na página e scroll
  function trackEngagement() {
    var maxScroll = 0;
    var startTime = Date.now();

    // Rastrear scroll
    window.addEventListener('scroll', function() {
      var scrollPercent = Math.round((window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100);
      if (scrollPercent > maxScroll) {
        maxScroll = scrollPercent;
      }
    });

    // Enviar dados de engajamento ao sair da página
    window.addEventListener('beforeunload', function() {
      var timeOnPage = Math.round((Date.now() - startTime) / 1000);

      // Só enviar se ficou mais de 2 segundos (evitar bounces instantâneos)
      if (timeOnPage > 2) {
        sendEvent('engagement', {
          timeOnPage: timeOnPage,
          maxScroll: maxScroll
        });
      }
    });
  }

  // Rastrear visibilidade da página
  function trackVisibility() {
    var hiddenTime = 0;
    var lastHidden = null;

    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        lastHidden = Date.now();
      } else if (lastHidden) {
        hiddenTime += Date.now() - lastHidden;
        lastHidden = null;
      }
    });
  }

  // API pública
  window.hubPixel = {
    // Rastrear conversão manualmente
    conversion: function(data) {
      sendEvent('conversion', data);
    },

    // Rastrear evento customizado
    track: function(eventType, data) {
      sendEvent(eventType, data);
    },

    // Rastrear checkout manualmente
    checkout: function(data) {
      sendEvent('checkout', data);
    },

    // Ativar modo debug
    debug: function(enabled) {
      DEBUG = enabled !== false;
      console.log('[HubPixel] Debug mode:', DEBUG ? 'ON' : 'OFF');
    },

    // Obter pixel ID atual
    getPixelId: function() {
      return PIXEL_ID;
    }
  };

  // Inicialização
  function init() {
    PIXEL_ID = getPixelId();
    API_BASE = getApiBase();

    if (!PIXEL_ID) {
      console.error('[HubPixel] Erro: pixelId não encontrado. Verifique a instalação do script.');
      return;
    }

    if (DEBUG) {
      console.log('[HubPixel] Inicializado:', { pixelId: PIXEL_ID, apiBase: API_BASE });
    }

    // Rastrear visita
    sendEvent('visit');

    // Configurar rastreamento de cliques
    trackClicks();

    // Configurar rastreamento de engajamento
    trackEngagement();

    // Configurar rastreamento de visibilidade
    trackVisibility();
  }

  // Executar quando DOM estiver pronto
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
